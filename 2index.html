<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Player IPTV HLS + DASH</title>
  <link href="https://vjs.zencdn.net/8.3.0/video-js.css" rel="stylesheet" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      background: #000;
    }
    .video-js {
      width: 100%;
      height: 100vh;
    }
    select {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      background: rgba(20,20,20,0.7);
      color: #fff;
    }
    .option-logo {
      height: 16px;
      vertical-align: middle;
      margin-right: 6px;
    }
    .error {
      position: absolute;
      bottom: 10px;
      left: 10px;
      color: #ff6b6b;
      font-weight: 600;
      background: rgba(0,0,0,0.6);
      padding: 6px 10px;
      border-radius: 6px;
      display: none;
    }
  </style>
</head>
<body>
  <!-- Menu dinamico -->
  <select id="srcSelect"></select>

  <!-- Player Video.js -->
  <video id="video" class="video-js vjs-default-skin" controls preload="auto" playsinline></video>

  <!-- Messaggi di errore -->
  <div id="errorBox" class="error">Errore nel caricamento dello stream.</div>

  <!-- Librerie Video.js -->
  <script src="https://vjs.zencdn.net/8.3.0/video.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/videojs-contrib-dash@latest/dist/videojs-dash.min.js"></script>

  <script>
    const select = document.getElementById('srcSelect');
    const errorBox = document.getElementById('errorBox');
    const player = videojs('video');

    // Funzione per caricare stream
    function loadStream(url) {
      errorBox.style.display = 'none';
      let type = "application/x-mpegURL"; // default HLS
      if (url.endsWith(".mpd")) type = "application/dash+xml"; // DASH
      player.src({ src: url, type: type });
      player.ready(() => {
        player.play().catch(err => console.warn("Autoplay bloccato:", err));
      });
    }

    function showError(msg) {
      errorBox.textContent = msg;
      errorBox.style.display = 'block';
    }

    // Parser M3U robusto
    function parseM3U(text) {
      const lines = text.split(/\r?\n/); // gestisce sia \n che \r\n
      const entries = [];
      for (let i = 0; i < lines.length; i++) {
        if (lines[i].startsWith("#EXTINF")) {
          const meta = lines[i];
          const name = meta.split(",").pop().trim();
          const logoMatch = meta.match(/tvg-logo="([^"]+)"/);
          const logo = logoMatch ? logoMatch[1] : null;
          const url = lines[i+1] ? lines[i+1].trim() : null;
          if (url && (url.startsWith("http://") || url.startsWith("https://"))) {
            entries.push({ name, url, logo });
          }
        }
      }
      return entries;
    }

    async function populateMenu() {
      try {
        // Carica lista TV dalla cartella m3u
        const tvRes = await fetch("https://cdn.jsdelivr.net/gh/Tundrak/IPTV-Italia@master/iptvitaplus.m3u");
        const tvText = await tvRes.text();
        const tvEntries = parseM3U(tvText);

        const tvGroup = document.createElement("optgroup");
        tvGroup.label = "TV Italiane";

        tvEntries.forEach((ch, i) => {
          const opt = document.createElement("option");
          opt.value = ch.url;
          if (ch.logo) {
            opt.innerHTML = `<img src="${ch.logo}" class="option-logo"> ${ch.name}`;
          } else {
            opt.textContent = ch.name;
          }
          if (i === 0) opt.selected = true;
          tvGroup.appendChild(opt);
        });

        // Carica lista Radio dalla cartella m3u
        const radioRes = await fetch("https://cdn.jsdelivr.net/gh/Tundrak/IPTV-Italia@master/iptvita.m3u");
        const radioText = await radioRes.text();
        const radioEntries = parseM3U(radioText);

        const radioGroup = document.createElement("optgroup");
        radioGroup.label = "Radio Italiane";

        radioEntries.forEach(ch => {
          const opt = document.createElement("option");
          opt.value = ch.url;
          if (ch.logo) {
            opt.innerHTML = `<img src="${ch.logo}" class="option-logo"> ${ch.name}`;
          } else {
            opt.textContent = ch.name;
          }
          radioGroup.appendChild(opt);
        });

        select.appendChild(tvGroup);
        select.appendChild(radioGroup);

        // Carica il primo canale
        loadStream(select.value);
      } catch (err) {
        console.error("Errore nel fetch M3U:", err);
        showError("Impossibile caricare la lista M3U.");
      }
    }

    select.addEventListener("change", () => loadStream(select.value));
    populateMenu();

    // Gestione errori Video.js
    player.on('error', () => {
      const err = player.error();
      if (err) showError("Errore Video.js: " + err.message);
    });
  </script>
</body>
</html>

