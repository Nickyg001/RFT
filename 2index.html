<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Player IPTV HLS + DASH</title>
  <link href="https://vjs.zencdn.net/8.3.0/video-js.css" rel="stylesheet" />
  <style>
    body { margin:0; background:#000; }
    .video-js { width:100%; height:100vh; }
    select {
      position:absolute; top:10px; left:10px; z-index:10;
      padding:6px 10px; border-radius:6px; border:none;
      background:rgba(20,20,20,0.7); color:#fff;
    }
    .option-logo {
      height:16px; vertical-align:middle; margin-right:6px;
    }
  </style>
</head>
<body>
  <!-- Menu dinamico -->
  <select id="srcSelect"></select>

  <!-- Player Video.js -->
  <video id="video" class="video-js vjs-default-skin" controls preload="auto" playsinline></video>

  <!-- Librerie Video.js -->
  <script src="https://vjs.zencdn.net/8.3.0/video.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/videojs-contrib-dash@latest/dist/videojs-dash.min.js"></script>

  <script>
    const select = document.getElementById('srcSelect');
    const player = videojs('video');

    // Funzione per caricare stream
    function loadStream(url) {
      let type = "application/x-mpegURL"; // default HLS
      if (url.endsWith(".mpd")) type = "application/dash+xml"; // DASH
      player.src({ src: url, type: type });
      player.ready(() => {
        player.play().catch(err => console.warn("Autoplay bloccato:", err));
      });
    }

    // Parser M3U
    function parseM3U(text) {
      const lines = text.split("\n");
      const entries = [];
      for (let i=0; i<lines.length; i++) {
        if (lines[i].startsWith("#EXTINF")) {
          const meta = lines[i];
          const name = meta.split(",").pop().trim();
          const logoMatch = meta.match(/tvg-logo="([^"]+)"/);
          const logo = logoMatch ? logoMatch[1] : null;
          const url = lines[i+1]?.trim();
          if (url && (url.startsWith("http://") || url.startsWith("https://") || url.endsWith(".mpd"))) {
            entries.push({name, url, logo});
          }
        }
      }
      return entries;
    }

    async function populateMenu() {
      try {
        // Crea sottogruppi
        const tvGroup = document.createElement("optgroup");
        tvGroup.label = "TV Italiane";
        const radioGroup = document.createElement("optgroup");
        radioGroup.label = "Radio Italiane";

        // Carica lista TV (file locale su GitHub Pages)
        const tvRes = await fetch("m3u/iptvitaplus.m3u");
        const tvText = await tvRes.text();
        const tvEntries = parseM3U(tvText);
        tvEntries.forEach((ch, i) => {
          const opt = document.createElement("option");
          opt.value = ch.url;
          if (ch.logo) {
            opt.innerHTML = `<img src="${ch.logo}" class="option-logo"> ${ch.name}`;
          } else {
            opt.textContent = ch.name;
          }
          if (i === 0) opt.selected = true;
          tvGroup.appendChild(opt);
        });

        // Carica lista Radio (file locale su GitHub Pages)
        const radioRes = await fetch("m3u/ipradioita.m3u");
        const radioText = await radioRes.text();
        const radioEntries = parseM3U(radioText);
        radioEntries.forEach(ch => {
          const opt = document.createElement("option");
          opt.value = ch.url;
          if (ch.logo) {
            opt.innerHTML = `<img src="${ch.logo}" class="option-logo"> ${ch.name}`;
          } else {
            opt.textContent = ch.name;
          }
          radioGroup.appendChild(opt);
        });

        select.appendChild(tvGroup);
        select.appendChild(radioGroup);

        // Carica il primo canale
        loadStream(select.value);
      } catch (err) {
        console.error("Errore nel fetch M3U:", err);
      }
    }

    select.addEventListener("change", () => loadStream(select.value));
    populateMenu();
  </script>
</body>
</html>
